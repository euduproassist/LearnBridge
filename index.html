<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>UJ Login - LearnBridge</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    .popup{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#ff4b4b;color:white;padding:12px 20px;border-radius:6px;display:none;font-weight:bold;z-index:9999}
    .popup.success{background:#28a745}
  </style>
</head>
<body class="login-page" style="background-image:url('assets/banners/uj-bg.jpg')">
  <div id="popup" class="popup"></div>
  <img src="assets/logos/uj.png" class="top-left-logo" alt="UJ Logo">

  <div class="login-box">
    <h2>LearnBridge ðŸŽ“</h2>

    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>

    <p>Don't have an account? <a href="signup.html">Sign Up</a></p>
    <p><a href="#" id="forgotLink" class="forgot">Forgot Password?</a></p>
    <p class="footer">Â© 2025 University of Johannesburg | LearnBridge</p>
  </div>

  <script type="module">
    import { auth, db } from './firebase-config.js';
    import { signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
    import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";


    function popup(msg, success=false){
      const p = document.getElementById('popup');
      p.textContent = msg;
      p.className = success ? 'popup success' : 'popup';
      p.style.display = 'block';
      setTimeout(()=> p.style.display='none', 3000);
    }

document.getElementById('loginBtn').addEventListener('click', async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  if (!email || !password) return popup('Enter email and password');

  try {
    const cred = await signInWithEmailAndPassword(auth, email, password);
    const user = cred.user;

    // ðŸš¨ FIX 1: This refreshes the user's status so Firebase knows they clicked the link
    await user.reload();

    const docRef = doc(db, 'users', user.uid);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      await auth.signOut();
      return popup('User profile not found. Please sign up or contact support.');
    }

    const data = docSnap.data();
    const now = new Date();
    const fourteenDaysInMs = 14 * 24 * 60 * 60 * 1000;
    const lastVerified = data.lastVerifiedDate ? new Date(data.lastVerifiedDate) : null;

    // 1. Check if Firebase says email is verified
    // ðŸš¨ FIX 2: Ensure this is checked as a property (no parentheses)
    if (!user.emailVerified) {
      await user.sendEmailVerification();
      return popup('Please verify your email. A link has been sent to your inbox.');
    }

    // 2. Check the 14-day rotation
    if (!lastVerified || (now - lastVerified) > fourteenDaysInMs) {
      await user.sendEmailVerification();
      await updateDoc(docRef, { lastVerifiedDate: null });
      return popup('14 days passed. A new verification link sent to your inbox.');
    }

    // If they just verified now, update the date
    if (user.emailVerified && !data.lastVerifiedDate) {
      await updateDoc(docRef, { lastVerifiedDate: now.toISOString() });
    }

    // ðŸ”‘ CORRECT REDIRECT BY ROLE
    if (data.role === 'student') window.location.href = 'student-portal.html';
    else if (data.role === 'tutor') window.location.href = 'tutor-portal.html';
    else if (data.role === 'counsellor') window.location.href = 'counsellor-portal.html';
    else if (data.role === 'admin') window.location.href = 'admin-portal.html';
    else window.location.href = 'student-portal.html';

  } catch (err) {
    let msg = err.code === 'auth/user-not-found' ? 'User not found or incorrect password.' : (err.message || 'Login failed.');
    popup('Login failed: ' + msg);
  }
});


// Updated Forgot password: allow any valid email format
document.getElementById('forgotLink').addEventListener('click', async (e) => {
  e.preventDefault();
  
  const email = prompt('Enter your registered email address:');
  
  // 1. Check if the user actually typed something
  if (!email) return;

  // 2. Simple regex to check for a basic email format (replaces the @uj.ac.za check)
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    alert('Please enter a valid email address.');
    return;
  }

  try {
    // Firebase will check if this email exists in your Auth database
    await sendPasswordResetEmail(auth, email);
    alert('If an account exists for ' + email + ', a password reset link has been sent. Please check your inbox.');
  } catch (err) {
    // Handle specific Firebase errors (like user-not-found) or general network errors
    console.error("Reset Error:", err);
    alert('Error: ' + err.message);
  }
});

  </script>
</body>
</html>

