the error
student-portal.js:1007 
 Chat listener failed:  FirebaseError: Missing or insufficient permissions.
(anonymous)	@	student-portal.js:1007
(anonymous)	@	bundle_reader_impl.ts:43
setTimeout		
Xa	@	bundle_reader_impl.ts:32
error	@	async_observer.ts:54
onError	@	event_manager.ts:485
__PRIVATE_eventManagerOnWatchError	@	event_manager.ts:367
__PRIVATE_removeAndCleanupTarget	@	sync_engine_impl.ts:941
(anonymous)	@	sync_engine_impl.ts:732
Promise.then		
__PRIVATE_syncEngineRejectListen	@	sync_engine_impl.ts:731
__PRIVATE_handleTargetError	@	remote_store.ts:655
__PRIVATE_onWatchStreamChange	@	remote_store.ts:59
onNext	@	persistent_stream.ts:684
(anonymous)	@	persistent_stream.ts:554
(anonymous)	@	persistent_stream.ts:599
(anonymous)	@	async_queue_impl.ts:138
(anonymous)	@	async_queue_impl.ts:330
Promise.then		
yu	@	async_queue_impl.ts:189
enqueue	@	async_queue_impl.ts:136
enqueueAndForget	@	async_queue_impl.ts:97
(anonymous)	@	persistent_stream.ts:597
(anonymous)	@	persistent_stream.ts:541
vo	@	webchannel_connection.ts:56
(anonymous)	@	webchannel_connection.ts:398
(anonymous)	@	webchannel_connection.ts:298
[NEW] Explain Console errors by using Copilot in Edge: click 
 to explain an error. Learn more
Don't show again
student-portal.js:1042 
 Error sending message: FirebaseError: Missing or insufficient permissions.
sendMessage	@	student-portal.js:1042
await in sendMessage		
$.onclick	@	student-portal.js:181

my rules 
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ---------------- GLOBAL HELPER FUNCTIONS ---------------- */
    function isAdmin() {
      // Uses custom admin claim (GOOD – keep this)
      return request.auth != null && request.auth.token.admin == true;
    }

    /* ---------------- USERS ---------------- */
    match /users/{userId} {
      allow read: if request.auth != null; 
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    /* ---------------- SESSIONS ---------------- */
    match /sessions/{sessionId} {
      function isSessionParticipant() {
        return request.auth.uid == resource.data.studentId || 
               request.auth.uid == resource.data.personId; 
      }

      // Required for conflict checks & chat contact loading
      allow read: if request.auth != null; 

      allow create: if request.auth != null
                  && request.resource.data.studentId == request.auth.uid; 

      allow update, delete: if request.auth != null
                          && (isSessionParticipant() || isAdmin());
    }

    /* ---------------- RATINGS ---------------- */
    match /ratings/{ratingId} {
      allow create: if request.auth != null
                 && request.resource.data.studentId == request.auth.uid; 
      
      allow read: if request.auth != null
                && (isAdmin()
                 || resource.data.studentId == request.auth.uid
                 || resource.data.personId == request.auth.uid); 
                 
      allow update, delete: if request.auth != null && isAdmin();
    }

    /* ---------------- CHATS ---------------- */

    // --- 1. TOP-LEVEL chats (Tutor / Counsellor) ---
    match /chats/{messageId} {

      function isTopLevelChatParticipant() {
        return request.auth.uid == resource.data.from || 
               request.auth.uid == resource.data.to;
      }

      allow create: if request.auth != null
                 && request.auth.uid == request.resource.data.from;

      allow read: if request.auth != null
               && (isTopLevelChatParticipant() || isAdmin());

      allow update, delete: if false;
    }

    // --- 2. NESTED chats (Student realtime chat) ---
    match /chats/{chatID}/messages/{messageId} {

      // ✅ FIXED: use chatID directly (SAFE & CORRECT)
      function isNestedChatParticipant() {
        return chatID.split('__').includes(request.auth.uid);
      }

      allow read: if request.auth != null
               && (isNestedChatParticipant() || isAdmin());

      allow create: if request.auth != null
                 && isNestedChatParticipant()
                 && request.auth.uid == request.resource.data.senderId;

      allow update, delete: if false;
    }

    /* ---------------- SUPPORT TICKETS ---------------- */
    match /supportTickets/{ticketId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null && isAdmin();
    }

    /* ---------------- ADMIN OVERRIDE ---------------- */
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}

