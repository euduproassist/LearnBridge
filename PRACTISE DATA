counsellor-portal.js:716 
 Chat listener failed: FirebaseError: Missing or insufficient permissions.
(anonymous)	@	counsellor-portal.js:716
(anonymous)	@	bundle_reader_impl.ts:43
setTimeout		
Xa	@	bundle_reader_impl.ts:32
error	@	async_observer.ts:54
onError	@	event_manager.ts:485
__PRIVATE_eventManagerOnWatchError	@	event_manager.ts:367
__PRIVATE_removeAndCleanupTarget	@	sync_engine_impl.ts:941
(anonymous)	@	sync_engine_impl.ts:732
Promise.then		
__PRIVATE_syncEngineRejectListen	@	sync_engine_impl.ts:731
__PRIVATE_handleTargetError	@	remote_store.ts:655
__PRIVATE_onWatchStreamChange	@	remote_store.ts:59
onNext	@	persistent_stream.ts:684
(anonymous)	@	persistent_stream.ts:554
(anonymous)	@	persistent_stream.ts:599
(anonymous)	@	async_queue_impl.ts:138
(anonymous)	@	async_queue_impl.ts:330
Promise.then		
yu	@	async_queue_impl.ts:189
enqueue	@	async_queue_impl.ts:136
enqueueAndForget	@	async_queue_impl.ts:97
(anonymous)	@	persistent_stream.ts:597
(anonymous)	@	persistent_stream.ts:541
vo	@	webchannel_connection.ts:56
(anonymous)	@	webchannel_connection.ts:398
(anonymous)	@	webchannel_connection.ts:298
[NEW] Explain Console errors by using Copilot in Edge: click 
 to explain an error. Learn more
Don't show again
counsellor-portal.js:692 
 send chat FirebaseError: Missing or insufficient permissions.
modal.querySelector.onclick	@	counsellor-portal.js:692








rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ---------------- GLOBAL HELPER FUNCTIONS ----------------
     * ADDED: A function to check if the user is an admin by checking their custom claims token.
     * The admin user must have this claim set on their Firebase Auth token (via the Firebase Admin SDK).
     * -----------------------------------------------------------*/
    function isAdmin() {
      // NOTE: This uses the custom token claim set by the Admin SDK.
      // This is the most secure method. 
      return request.auth.token.admin == true;
    }
    
    /* ---------------- USERS ----------------
     * Only the authenticated user can read/write their own profile
     * FIX: Allow authenticated users to READ any profile (tutors, counsellors) 
     * so the student portal can display names in the chat list.
     * ----------------------------------------*/
    match /users/{userId} {
      // Allow any authenticated user to read (for fetching tutor/counselor names)
      // Allow admin to read/write all user profiles for management.
      allow read: if request.auth != null; 
      
      // Only allow a user to write/update their OWN profile
      // Allow admin to write/update any profile
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    /* ---------------- SESSIONS (FIXED FOR ADMIN PORTAL) ----------------
     * ADDED: The Admin must be able to read all sessions to calculate dashboard metrics.
     * ----------------------------------------*/
    match /sessions/{sessionId} {
      // Helper function to check if the user is a participant
      function isSessionParticipant() {
        return request.auth.uid == resource.data.studentId || 
               resource.data.personId == request.auth.uid; // Minor optimization to use resource.data
      }
      
      // Students can only CREATE sessions where the studentId field is their UID
      allow create: if request.auth != null
                  && request.resource.data.studentId == request.auth.uid; 

      // Students/Counsellors can READ if they are a participant (studentId OR personId)
      // ADDED: Allow read if the user is an Admin
      allow read: if request.auth != null
                && (isSessionParticipant() || isAdmin()); 

      // Students/Counsellors can UPDATE/DELETE if they are a participant
      // ADDED: Allow Admin to update/delete all sessions
      allow update, delete: if request.auth != null
                          && (isSessionParticipant() || isAdmin());
    }

/* ---------------- RATINGS (FIXED) ----------------
 * Students create, students read their own, Admins read/manage all, and Counsellors read ratings about them.
 * ----------------------------------------*/
match /ratings/{ratingId} {
  // Student creates rating -> studentId must match their UID
  allow create: if request.auth != null
             && request.resource.data.studentId == request.auth.uid; 
  
  // ALLOW READ if: Admin OR Student created it OR Counsellor is the Person rated (personId)
  // Replaced request.auth.token.admin == true with isAdmin()
  allow read: if request.auth != null
            && (isAdmin()
             || resource.data.studentId == request.auth.uid
             || resource.data.personId == request.auth.uid); 
             
  // Only admin can modify or delete
  // Replaced request.auth.token.admin == true with isAdmin()
  allow update, delete: if request.auth != null
                      && isAdmin();
}
    
    /* ---------------- CHATS ----------------
     * Chats are between two parties (studentId and personId)
     * Both must be involved to access the main chat document
     * ADDED: Allow Admin read access to all chats
     * ----------------------------------------*/
    match /chats/{chatId} {
      allow read, write: if request.auth != null 
                       && (isAdmin()
                        || resource.data.studentId == request.auth.uid
                        || resource.data.personId == request.auth.uid);

      // Messages subcollection: Inherits read/write from parent, but explicitly secured
      match /messages/{messageId} {
        allow read, write: if request.auth != null 
                         && (isAdmin()
                          || getParent(chatId).data.studentId == request.auth.uid
                          || getParent(chatId).data.personId == request.auth.uid);
      }
    }
    
    /* ---------------- SUPPORT TICKETS ----------------
     * Students create, only Admins read/manage
     * ----------------------------------------*/
    match /supportTickets/{ticketId} {
      // Only authenticated users can create a ticket
      allow create: if request.auth != null;
      
      // Only admins can read/update/delete tickets
      // Replaced request.auth.token.admin == true with isAdmin()
      allow read, update, delete: if request.auth != null 
                                && isAdmin();
    }

    // ADDED: General Admin Access for other administrative collections
    // You should add these for any other collections your dashboard loads data from
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
