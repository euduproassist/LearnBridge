rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ---------------- GLOBAL HELPER FUNCTIONS ---------------- */
    function isAdmin() {
      // Uses custom admin claim (GOOD â€“ keep this)
      return request.auth != null && request.auth.token.admin == true;
    }

    /* ---------------- USERS ---------------- */
    match /users/{userId} {
      allow read: if request.auth != null; 
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    /* ---------------- SESSIONS ---------------- */
    match /sessions/{sessionId} {
      function isSessionParticipant() {
        return request.auth.uid == resource.data.studentId || 
               request.auth.uid == resource.data.personId; 
      }

      // Required for conflict checks & chat contact loading
      allow read: if request.auth != null; 

      allow create: if request.auth != null
                  && request.resource.data.studentId == request.auth.uid; 

      allow update, delete: if request.auth != null
                          && (isSessionParticipant() || isAdmin());
    }

    /* ---------------- RATINGS ---------------- */
    match /ratings/{ratingId} {
      allow create: if request.auth != null
                 && request.resource.data.studentId == request.auth.uid; 
      
      allow read: if request.auth != null
                && (isAdmin()
                 || resource.data.studentId == request.auth.uid
                 || resource.data.personId == request.auth.uid); 
                 
      allow update, delete: if request.auth != null && isAdmin();
    }

    /* ---------------- CHATS (STANDARDIZED NESTED STRUCTURE) ---------------- */

    // NOTE: The top-level /chats/{messageId} rule has been removed 
    // to enforce the correct nested path structure used by the client code.

    // 1. NESTED chat messages: /chats/{chatID}/messages/{messageId}
    match /chats/{chatID}/messages/{messageId} {

      function isNestedChatParticipant() {
        // Ensures the current user's UID is one of the two IDs that form the chatID
        return chatID.split('__').includes(request.auth.uid);
      }

      // User can read if they are a participant or an admin
      allow read: if request.auth != null
               && (isNestedChatParticipant() || isAdmin());

      // User can create a message if they are a participant AND the senderId matches their UID
      allow create: if request.auth != null
                 && isNestedChatParticipant()
                 && request.auth.uid == request.resource.data.senderId;

      allow update, delete: if false;
    }
    
    // 2. CHAT DOCUMENT: /chats/{chatID} (Allows read/write of the parent document, e.g., for 'lastMessageAt' updates)
    match /chats/{chatID} {
        function isNestedChatParticipant() {
            return chatID.split('__').includes(request.auth.uid);
        }
        
        allow read, update: if request.auth != null 
                         && (isNestedChatParticipant() || isAdmin());
        // Students/Counsellors should not delete the main chat document
        allow delete: if false; 
        
        // Allow creation for both users if it doesn't exist (when the first message is sent)
        allow create: if request.auth != null 
                   && isNestedChatParticipant();
    }


    /* ---------------- SUPPORT TICKETS ---------------- */
    match /supportTickets/{ticketId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null && isAdmin();
    }

    /* ---------------- ADMIN OVERRIDE ---------------- */
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
